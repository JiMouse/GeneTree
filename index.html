<!DOCTYPE html>
<html lang="en">
<head>
	<title>GeneTree</title>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,maximum-scale=2">

	<link href="https://code.jquery.com/ui/1.12.1/themes/cupertino/jquery-ui.css" rel="stylesheet" type="text/css" media="all" />
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all" />
	<link rel="stylesheet" href="dist/css/pedigreejs.min.css" />

	<style>
		a[href^="http://"][target=_blank]:after, 
		a[href^="https://"][target=_blank]:after, 
		a[href^="ftp://"][target=_blank]:after {
		  content: "\f08e";
		  font-family: FontAwesome;
		  font-weight: normal;
		  font-style: normal;
		  display: inline-block;
		  text-decoration: none;
		  padding: 0px 2px;
		  display:inline;
		}

		.fa-rotate-45 {
			-webkit-transform:rotate(45deg); 
			-moz-transform:rotate(45deg); 
			-ms-transform:rotate(45deg); 
			-o-transform:rotate(45deg);
			transform:rotate(45deg);
		}
	</style>

	<script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> 
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://unpkg.com/d3@4.13.0/build/d3.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
	<!-- <script src="dist/js/pedigreejs.min.js"></script> -->
    <script src="js/io.js"></script>
    <script src="js/pedigree_form.js"></script>
    <script src="js/pedigree.js"></script>
    <script src="js/undo_redo_refresh.js"></script>
	<script src="js/widgets.js"></script>
	
	<!-- main script -->
	<script type="text/javascript" src="js/main.js"></script>
	<script src="package/lodash.js"></script>
	
	<script type="text/javascript">
	if(utils.isIE() || utils.isEdge()) {
		//<!-- canvg used to convert svf to png image -->
		document.write('<script src="https://cdn.jsdelivr.net/npm/canvg@2.0.0/dist/browser/canvg.min.js"><\/script>');
	}

	$( document ).ready(function() {
		var DEBUG = (pedigree_util.urlParam('debug') === null ? false : true);

		////////////////////
		var dataset = [
			{"name": "m11", "sex": "M", "top_level": true},
			{"name": "f11", "display_name": "Jane",  "sex": "F", "status": 1, "top_level": true, "breast_cancer_diagnosis_age":67, "ovarian_cancer_diagnosis_age":63},
			{"name": "m12", "sex": "M", "top_level": true},
			{"name": "f12", "sex": "F", "top_level": true, "breast_cancer_diagnosis_age":55},
			{"name": "m21", "sex": "M", "mother": "f11", "father": "m11", "age": 56},
			{"name": "f21", "sex": "F", "mother": "f12", "father": "m12", "breast_cancer_diagnosis_age":55, "breast_cancer2_diagnosis_age": 60, "ovarian_cancer_diagnosis_age":58, "age": 63},
			{"name": "ch1", "display_name": "Ana", "sex": "F", "mother": "f21", "father": "m21", "proband": true, "age": 25}
		];
		$( "#pedigrees" ).append( $( "<div id='pedigree_history'></div>" ) );
		$( "#pedigrees" ).append( $( "<div id='pedigree'></div>" ) );

		var opts = {
				'targetDiv': 'pedigree',
				'btn_target': 'pedigree_history',
				//'nodeclick': pedigree_form.nodeclick,
				'width': ($(window).width() > 450 ? 900 : $(window).width()- 30),
				'height': 600,
				'symbol_size': 30,
				'edit': true,
				'zoomIn': .8,
				'zoomOut': 3.,
				'font_size': '0.75em',
				'edit': true,
	        	'diseases': [{'type': 'breast_cancer', 'colour': '#F68F35'},
	        				 {'type': 'breast_cancer2', 'colour': 'pink'},
							 {'type': 'ovarian_cancer', 'colour': '#4DAA4D'},
							 {'type': 'pancreatic_cancer', 'colour': '#4289BA'},
							 {'type': 'prostate_cancer', 'colour': '#D5494A'}],
				'DEBUG': (pedigree_util.urlParam('debug') === null ? false : true)};
				
		var local_dataset = pedcache.current(opts);
		if (local_dataset !== undefined && local_dataset !== null) {
			opts.dataset = local_dataset;
		} else {
			opts.dataset = dataset;
		}
		opts= ptree.build(opts);

		// Update dataset from handsontable
		function loadFromHot() {
			let myDeepClone = JSON.stringify(hot.getSourceData()) //save hot
			var new_key = ['famid','display_name','name','father','mother','sex', 'affected', 'status'];
			var old_key  = ['FamID','Name','IndivID','FathID','MothID','Sex', 'Affected', 'Deceased'];
			
			var obj = FormatToPedigreeJS(hot.getSourceData(), new_key, old_key);
			opts.dataset = obj

			$('<div id="msgDialog">Resetting the pedigree may result in loss of some data.</div>').dialog({
					title: 'Confirm Reset',
					resizable: false,
					height: "auto",
					width: 400,
					modal: true,
					buttons: {
						Continue: function() {
					    	ptree.rebuild(opts)
					    	$(this).dialog( "close" );
						},
						Cancel: function() {
							$(this).dialog( "close" );
							return;
					    }
					}
				});
			
			hot.loadData(JSON.parse(myDeepClone)) //reload hot. Otherwise hot is cleared. Bug ?
		}

		$('#loadFromHot').click(function() {
			loadFromHot();
		});
		
	});
	</script>

	<!-- load handsontable module --> 
	<script src="https://cdn.jsdelivr.net/npm/handsontable@7.4.2/dist/handsontable.full.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/handsontable@7.4.2/dist/handsontable.full.min.css" rel="stylesheet" media="screen">

</head>

<body>	
	<div style="margin:0 auto;text-align:center">
		<h3>GeneTree</h3>
		
		<!-- create buttons -->
		<button id="reset" class="intext-btn">Reset</button>
		<script> var buttonParents = document.getElementById('reset');
			Handsontable.dom.addEvent(buttonParents, 'click', function() {

				$('<div id="msgDialog2">Resetting the pedigree may result in loss of some data.</div>').dialog({
					title: 'Confirm Reset',
					resizable: false,
					height: "auto",
					width: 400,
					modal: true,
					buttons: {
						Continue: function() {
					    	hot.loadData(JSON.parse(myDataSafe))
					    	$(this).dialog( "close" );
						},
						Cancel: function() {
							$(this).dialog( "close" );
							return;
					    }
					}
				});

			});
		</script>
		&nbsp &nbsp &nbsp

		<button id="add-parents" class="intext-btn">Add parents</button>
		<script> var buttonParents = document.getElementById('add-parents');
			Handsontable.dom.addEvent(buttonParents, 'click', function() {
				createParents()
			});
		</script>
		<button id="add-brother" class="intext-btn">Add brother</button>
		<script> var buttonParents = document.getElementById('add-brother');
			Handsontable.dom.addEvent(buttonParents, 'click', function() {
				createBrother()
			});
		</script>
		<button id="add-sister" class="intext-btn">Add sister</button>
		<script> var buttonParents = document.getElementById('add-sister');
			Handsontable.dom.addEvent(buttonParents, 'click', function() {
				createSister()
			});
		</script>
		<div></div>
		</br>

		<!-- create handsontable table -->
		<div id="example" style="width:100%;margin-left:30%;"></div>
		<script>
			var myData = [{
			"FamID": "1",
			"Name": "",
			"IndivID": "1",
			"FathID": "2",
			"MothID": "3",
			"Sex": "M",
			"Affected":"1",
			"Deceased":"0",
			"proband": true,
		},{
			"FamID": "1",
			"Name": "",
			"IndivID": "2",
			"FathID": "0",
			"MothID": "0",
			"Sex": "M",
			"Affected":"1",
			"Deceased":"0",
		},{
			"FamID": "1",
			"Name": "",
			"IndivID": "3",
			"FathID": "0",
			"MothID": "0",
			"Sex": "F",
			"Affected":"1",
			"Deceased":"0",
		}]
			var myDataSafe = JSON.stringify(myData) //save 
			var container = document.getElementById('example');
		
		// define column to display
		var cols = [{
			data: 'FamID'
			}, {
			data: 'Name'
			}, {
			data: 'IndivID'
			}, {
			data: 'FathID'
			}, {
			data: 'MothID'
			}, {
			data: 'Sex'
			}, {
			data: 'Affected'
			}, {
			data: 'Deceased'
			}];

		// define column header //['FamID','Name','IndivID','FathID','MothID','Sex']
		var cols_header = []
		cols.forEach(function(element) { cols_header.push(element.data); })

		var hot = new Handsontable(container, {
			data: myData,
			rowHeaders: true,
			colHeaders: cols_header, 
			columns: cols,
			filters: true,
			dropdownMenu: true,
			className: "htCenter",
			contextMenu: true,
			outsideClickDeselects: false,
			licenseKey: 'non-commercial-and-evaluation'
			});
		</script>
		</br>

		<!-- create export to TSV button -->
		<button id="export-file" class="intext-btn">Download TSV</button>
		<script> var button1 = document.getElementById('export-file');
  		var exportPlugin1 = hot.getPlugin('exportFile');
  
		button1.addEventListener('click', function() {
			exportPlugin1.downloadFile('csv', {
			bom: false,
			columnDelimiter: '\t',
			columnHeaders: cols_header,
			exportHiddenColumns: true,
			exportHiddenRows: true,
			fileExtension: 'tsv',
			filename: 'GeneTree_[YYYY]-[MM]-[DD]',
			mimeType: 'text/csv',
			rowDelimiter: '\r\n',
			rowHeaders: false
			});
		});
		</script>

		<!-- create export to PED button -->		
		<button id="savePed" class="intext-btn">Download as PED</button>
		<script>
		Handsontable.dom.addEvent(savePed, 'click', function() {
			var toKeep = ['FamID','IndivID','FathID','MothID','Sex','Affected']
			JSONToPEDConvertor(hot.getSourceData(), toKeep); 
  		});
		</script>

		<!-- create export to JSON button -->
		<button id="exportJson" class="intext-btn">Download as JSON</button>
		<script>
		Handsontable.dom.addEvent(exportJson, 'click', function() {
			let myDeepClone = JSON.stringify(hot.getSourceData()) //save hot

			var new_key = ['famid','display_name','name','father','mother','sex', 'affected', 'status']
			var old_key  = ['FamID','Name','IndivID','FathID','MothID','Sex', 'Affected', 'Deceased']
			ExportJSON(hot.getSourceData(), new_key, old_key)

			hot.loadData(JSON.parse(myDeepClone)) //reload hot. Otherwise hot is cleared. Bug ?
		});
		</script>

	<br>
	<!-- create pedigree buttons -->
	<div class="text-center">
		<h3>Pedigree</h3>
		<label class="btn btn-default btn-file">
			<input id="loadFromHot" type="button" style="display: none;"/>Update from table
		</label>
		<label class="btn btn-default btn-file">
				<input id="load" type="file" style="display: none;"/>Load
		</label>	
		<label class="btn btn-default btn-file">
				<input id="save" type="button" style="display: none;"/>Save
		</label>
		<label class="btn btn-default btn-file">
				<input id="svg_download" type="button" style="display: none;"/>SVG
		</label>
		<label class="btn btn-default btn-file">
				<input id="png_download" type="button" style="display: none;"/>PNG
		</label>
		<!--<label class="btn btn-default btn-file">
			<input id="fh_edit_settings" type="button" style="display: none;"><i class="fa fa-cog" aria-hidden="true"></i>
		</label>-->

		<!-- create pedigree -->
		<div id="pedigrees"></div>
		<div id="node_properties"></div>
		<br>
	</div>
	<div class="text-center">
		<h3>Pedigree history</h3>
		<textarea id="story" name="story" rows="5" cols="33"></textarea>
		<script>
			var rawData = {
                "FamID": "1",
                "Name": "",
                "IndivID": "1",
                "FathID": "2",
                "MothID": "3",
                "Sex": "F",
                "Affected":"1",
                "Deceased":"0"
                }
				
			var result = "il s'agit d'un " + rawData.Sex
			+ "de x ans, né(e) en y."

			document.getElementById('story').value = result

		</script>
		

	</div>
</body>

</html>
