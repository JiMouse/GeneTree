<!DOCTYPE html>
<html lang="fr">
<head>
	<title>GeneTree</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,maximum-scale=2">
	<meta name="author" content="Jean-Marie Ravel">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<!-- load bootstrap dependencies -->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>

	<!-- load pedigreejs dependencies : jquery, bootstrap, font-awesome, d3 -->
	<link href="https://code.jquery.com/ui/1.12.1/themes/cupertino/jquery-ui.css" rel="stylesheet" type="text/css" media="all" />
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all" />

	<script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> 
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://unpkg.com/d3@4.13.0/build/d3.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
	
	<script src="package/lodash.js"></script>

	<!-- load pedigreejs -->
    <script src="js/io.js"></script>
    <script src="js/pedigree_form.js"></script>
    <script src="js/pedigree.js"></script>
    <script src="js/undo_redo_refresh.js"></script>
	<script src="js/widgets.js"></script>
	
	<!-- main script -->
	<script type="text/javascript" src="js/main.js"></script>
	<script type="text/javascript" src="js/story.js"></script>
	<script type="text/javascript" src="data/diseases.js"></script>
	<script type="text/javascript" src="js/table.js"></script>
	<script type="text/javascript" src="js/HPO.js"></script>

	<link rel="stylesheet" type="text/css" href="css/main.css">
	
	<!-- load handsontable module --> 
	<script src="https://cdn.jsdelivr.net/npm/handsontable@7.4.2/dist/handsontable.full.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/handsontable@7.4.2/dist/handsontable.full.min.css" rel="stylesheet" media="screen">
</head>

<body>
	<div class="jumbotron">
		<div class="container">
				  <a class="btn btn-primary btn-lg pull-right" role="button" href="https://github.com/JiMouse/GeneTree/">GitHub</a>
				  <h1><i>GeneTree</i></h1>
				  <h2>Un outil intégré pour construire un arbre généalogique, téléchargeable en fichier BOADICEA, et l'histoire clinique d'une famille.</h2>
		</div>
	</div>

	<div class="container">
		<!-- Table --> 
		<div class = "row">
			<!-- Title--> 
			<div class="panel">
				<div class="panel-heading" style="background-color: #dbe9f5;"><h3>Tableau</h3></div>
			</div>

			<!-- Buttons --> 
			<div style="padding:0px 20px 15px;">
				<div class="text-center">
					<!--  buttons edit familly -->
					<div class="dropdown" id="dropdownFam" style="display:inline;">
						<button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Nouvelle famille&nbsp;
						<span class="caret"></span></button>
						<ul class="dropdown-menu" style="padding:10px;min-width:300px">
							<li><div class="text-center" style="padding:0px 10px;">
								<label class="btn btn-primary btn-block">
									<i class="fa fa-folder-open-o"><abbr title="Format JSON ou Boadicea"> Charger un fichier </abbr></i><input id="submitLoad" type="file" hidden>
								</label>
							</div></li>
							<li class="divider"></li>
							<li><div class="text-center">
								<label class="radio-inline"><input type="radio" name="optradio" id="nuclear">Noyau</label>
								<label class="radio-inline"><input type="radio" name="optradio" id="extended1">1<sup>er</sup> degré</label>
								<label class="radio-inline"><input type="radio" name="optradio" id="extended2">2<sup>ième</sup> degré</label>
							</div></li>
							<li class="divider"></li>
							<li>
								<div class="row text-center">
									<b>Créer une famille</b>
									<div class="btnDivider"></div>
									<i id="clearFam"  title="Vider les champs" class="fa fa-eraser" aria-hidden="true" style="color: grey;"></i>
								</div>
								<p>

									<div class="row" style='padding-bottom: 5px;'>
										<div class="col-sm-2 text-right"><label style='font-weight: normal;'>frères</label></div>
										<div class="col-sm-3"><input type="number" id="brother" min="0" max="20"></div>

										<div class="col-sm-2 text-right"><label style='font-weight: normal;'>sœurs</label></div>
										<div class="col-sm-2"><input type="number" id="sister" min="0" max="20"></div>
									</div>
									
									<div class="row">
										<div class="col-sm-2 text-right"><label style='font-weight: normal;'>fils</label></div>
										<div class="col-sm-3"><input type="number" id="son" min="0" max="20"></div>

										<div class="col-sm-2 text-right"><label style='font-weight: normal;'>filles</label></div>
										<div class="col-sm-2"><input type="number" id="daughter" min="0" max="20"></div>
									</div>
									<p>
										<div class="row text-center" style='padding-bottom: 5px;'><i>Branche paternelle</i></div>
										<div class="row">
											<div class="col-sm-2 text-right"><label style='font-weight: normal;'>oncles</label></div>
											<div class="col-sm-3"><input type="number" id="uncleP" min="0" max="20"></div>

											<div class="col-sm-2 text-right"><label style='font-weight: normal;'>tantes</label></div>
											<div class="col-sm-2"><input type="number" id="auntP" min="0" max="20"></div>
										</div>
									</p>
									<p>
										<div class="row text-center" style='padding-bottom: 5px;'><i>Branche maternelle</i></div>
										<div class="row">
											<div class="col-sm-2 text-right"><label style='font-weight: normal;'>oncles</label></div>
											<div class="col-sm-3"><input type="number" id="uncleM" min="0" max="20"></div>
											
											<div class="col-sm-2 text-right"><label style='font-weight: normal;'>tantes</label></div>
											<div class="col-sm-2"><input type="number" id="auntM" min="0" max="20"></div>
										</div>
									</p>
								</p>
								<div class="row">
									<div class="text-center">
										<div class="btn-group"> 
											<button id="submitCustomFam" class="btn btn-primary btn-sm">Créer un nouvel arbre</button>
											<button id="submitAddBranch" class="btn btn-primary btn-sm">Ajouter à l'individu</button>
										</div>
									</div>
								</div>
							</li>
						</ul>
					</div>

					<!-- create buttons -->
					<button id="loadFormPedigree" title="Charger depuis l'arbre généalogique" class="btn  btn-primary">Charger l'arbre <i class="fa fa-refresh"></i></button>
					<div class="btnDivider"></div>

					<button id="reload" title="Charger depuis la sauvegarde locale" class="btn btn-primary"><i class="fa fa-refresh"></i></button>
					<button id="reset" title="Réinitialiser" class="btn btn-primary"><i class="fa fa-eraser" aria-hidden="true"></i></button>
					<button id="undo" title="Défaire" class="btn btn-primary"><i class="fa fa-undo" aria-hidden="true"></i></button>
					<button id="redo" title="Refaire" class="btn btn-primary"><i class="fa fa-repeat" aria-hidden="true"></i></button>
					<div class="btnDivider"></div>

					<button id="add-parents" title="Ajouter des parents" class="btn btn-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> parents</button>
					<button id="add-brother" title="Ajouter un frère" class="btn btn-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> frère</button>
					<button id="add-sister" title="Ajouter une sœur" class="btn btn-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> sœur</button>
					<button id="add-son" title="Ajouter un fils" class="btn btn-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> fils</button>
					<button id="add-daughter" title="Ajouter une fille" class="btn btn-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> fille</button>
					<button id="add-partner" title="Ajouter un nouveau conjoint avec un enfant" class="btn btn-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> conjoint</button>
					<div class="btnDivider"></div>
					
					<label class="switch">
						<input type="checkbox" id="myCheckOnco" checked> 
						<span class="slider round" for="myCheckOnco" ></span>
					</label>
					<label style='font-weight: normal;'>Onco</label>
					<div class="btnDivider"></div>

					<label class="switch">
						<input type="checkbox" id="myCheckHPO"> 
						<span class="slider round" for="myCheckHPO" ></span>
					</label>
					<label style='font-weight: normal;'>HPO</label>
				</div>
			</div>

			<div class="row" style="padding:0px 30px;">
				<div class="text-center">
					<!-- create handsontable table -->
					<div class='hotContainer' style="height: 250px;">
						<div id="dataTable" class="hot handsontable htColumnHeaders" style="display:inline-block;z-index: 0;min-height:100px;"></div>
					</div>
					<script>
						// create handsonetable
						var container = document.getElementById('dataTable');
						var hot = new Handsontable(container, {
							data: myData,
							rowHeaders: false,
							colHeaders: cols_headerOnco, 
							columns: colsOnco,
							filters: true,
							dropdownMenu: true,
							className: "htCenter",
							contextMenu: true,
							outsideClickDeselects: false,
							persistentState: true,
							undo: true,
							width: '100%',
							height: '100%',
							hiddenColumns: {
								columns: [0,6], //hide famID and affected columns
								indicators: false
							},
							licenseKey: 'non-commercial-and-evaluation',
							afterChange: function (change, source) {
								// save all data to local storge if the edit happends
								if (source !== "loadData") {								
									sessionStorage['data'] = JSON.stringify(this.getSourceData());
									return
								}
							}
							});

						var setter = false;
						hot.addHook('afterChange', 
							function(changes, source) {
								if(changes != null) {
									col = changes[0][1];
									var deceasedIndex = 7
									row = changes[0][0];
									dead = this.getSourceDataAtCell(row, deceasedIndex)
									if((source == 'edit') && (changes.length == 1) && (col == 'Age' || col == 'Yob') && (dead != 1)) {
										newValue = changes[0][3];
										var today = new Date();
										var y = today.getFullYear();
										if (!setter) {
												setter = true;
											if(col == 'Age'){
												let value = y-newValue
												this.setDataAtRowProp(row, 'Yob', value)

											}else {
												let value = y-newValue
												this.setDataAtRowProp(row, 'Age', value)
											}
										} else {
											setter = false;
										}
									}
								}
							}
						);	
					</script>

					<!-- create export buttons -->
					<div style="padding-top: 15px;">
						<button id="exportJson" title="Données brutes" class="btn btn-primary">JSON <i class="fa fa-download"></i></button>
						<div class="btnDivider"></div>
						<button id="exportBOADICEA" title="Format BOADICEA v4.0" class="btn btn-primary">BOADICEA <i class="fa fa-download"></i></button>
						<div class="btnDivider"></div>

						<!-- create dropdown button to other export file -->
						<div class="dropdown" style="display:inline;">
							<button class="dropdown btn btn-primary" type='button' id="export" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Autres formats" >
								Exporter... &nbsp;<span class="caret"></span>
							</button>
							<div class="dropdown-menu" aria-labelledby="export" style="width: 100% !important; min-width: 100%; max-width: 100%;padding:5px;">
								<button id="export-file" title="Télécharger le tableau" class="btn btn-block">TSV</button>
								<button id="savePed" title="Fichier Plink" class="btn btn-block">PED</button>
								<button id="exportPedigreejs" title="Fichier compatible avec Pedigreejs" class="btn btn-block">Pedigreejs</button>
							</div>
						</div>

						<div class="btnDivider"></div>
						<a target="_blank" title="Lien vers BOADICEA v4.0" rel="noopener noreferrer" href="https://pluto.srl.cam.ac.uk/cgi-bin/bd4/v4beta14/bd.cgi">Boadicea</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Tree -->
		<div class='row' style="padding-top: 20px;">
			<div class="panel">
				<div class="panel-heading" style="background-color: #dbe9f5;"><h3>Arbre généalogique</h3></div>
			</div>

			<div class="text-center">
				<button id="loadFromHot" class='btn btn-primary'>Charger le tableau <i class="fa fa-refresh"></i></button>
				<label class="btn btn-primary">
					<i class="fa fa-folder-open-o"></i><input id="load" type="file" hidden>
				</label>
				<div class="btnDivider"></div>

				<button id="save" class='btn btn-primary'>JSON <i class="fa fa-download"></i></button>
				<button id="boadicea_download"class='btn btn-primary'>BOADICEA <i class="fa fa-download"></i></button>
				<div class="btnDivider"></div>

				<button id="svg_download" class='btn btn-primary'>SVG <i class="fa fa-download"></i></button>
				<button id="png_download" class='btn btn-primary'>JPEG <i class="fa fa-download"></i></button>
				<button id="print" class='btn btn-primary'>Imprimer</button>
				<div class="btnDivider"></div>

				<button id="fh_edit_settings" class='btn btn-primary'><i class="fa fa-cog" aria-hidden="true"></i></button>
				<br></br>

				<!-- create pedigree -->
				<div id="pedigrees"></div>
				<div id="node_properties"></div>

				<!-- create disease settings -->
				<div id="fh_settings"></div>
				<div id="reset_dialog" title="Confirmation de la réinitialisation des maladies"></div>
			</div>
		</div>

		<!-- Story -->
		<div class='row'  style="padding-top: 20px;">
			<div class="panel">
				<div class="panel-heading" style="background-color: #dbe9f5;margin: 0;">
					<h3 style="background-color: #dbe9f5;display: inline-block; margin-right: 10px;">Histoire clinique</h3>
					<button class='btn btn-light btn-sm' id="loadStory" title ='Màj texte'><i class="fa fa-refresh"></i></button>
					<button class='btn btn-light btn-sm' id="copyToClip">Copier</button>
				</div>
			</div>
			
			<p>
				<div id="story" contenteditable="true"  style="padding:0px 20px;"></div>
			</p>
		</div>

		<!-- References -->
		<div class='row' style="padding-top: 20px;">
			<h3>Références</h3>
			<div>
				<p><strong>pedigreejs: a web-based graphical pedigree editor</strong><br>
					Carver T, Cunningham AP, Babb de Villiers C, Lee A, Hartley S, Tischkowitz M, et al. 
					<i>Bioinformatics <a href="http://dx.doi.org/10.1093/bioinformatics/btx705" target="_blank">
					doi:10.1093/bioinformatics/btx705</a></i>
				</p>
				<p><strong>HPO-translations</strong><br>
					<a href="https://github.com/drseb/HPO-translations" target="_blank">drseb/HPO-translations</a>
				</p>
				<p>

					Copyright : Jean-Marie Ravel, 2020
					<br>
					<a href="mailto:jmravel.dev@gmail.com?	subject=GeneTree">Contact : jmravel.dev@gmail.com</a>
				</p>

			</div>
		</div>
	</div>
</body>

</html>