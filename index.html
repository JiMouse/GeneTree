<!DOCTYPE html>
<html lang="en">
<head>
	<title>GeneTree</title>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,maximum-scale=2">

	<link href="https://code.jquery.com/ui/1.12.1/themes/cupertino/jquery-ui.css" rel="stylesheet" type="text/css" media="all" />
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all" />
	<link rel="stylesheet" href="dist/css/pedigreejs.min.css" />

	<script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> 
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://unpkg.com/d3@4.13.0/build/d3.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>

    <script src="js/io.js"></script>
    <script src="js/pedigree_form.js"></script>
    <script src="js/pedigree.js"></script>
    <script src="js/undo_redo_refresh.js"></script>
	<script src="js/widgets.js"></script>
	
	<!-- main script -->
	<script type="text/javascript" src="js/main.js"></script>
	<script src="package/lodash.js"></script>
	
	<script type="text/javascript">
	if(utils.isIE() || utils.isEdge()) {
		//<!-- canvg used to convert svf to png image -->
		document.write('<script src="https://cdn.jsdelivr.net/npm/canvg@2.0.0/dist/browser/canvg.min.js"><\/script>');
	}

	function capitaliseFirstLetter(string) {
	    return string.charAt(0).toUpperCase() + string.slice(1);
	}
	var DEFAULT_DISEASES = [
		 {'type': 'breast_cancer', 'colour': '#F68F35'},
		 {'type': 'breast_cancer2', 'colour': 'pink'},
		 {'type': 'ovarian_cancer', 'colour': '#4DAA4D'},
		 {'type': 'pancreatic_cancer', 'colour': '#4289BA'},
		 {'type': 'prostate_cancer', 'colour': '#D5494A'}
	];

	$( document ).ready(function() {
		// build tree
		var DEBUG = (pedigree_util.urlParam('debug') === null ? false : true);

		var dataset = [
			{"famid":"1","display_name":"","name":"1","father":"2","mother":"3","sex":"M", "proband":true},
			{"famid":"1","display_name":"","name":"2","sex":"M","top_level":"true"},
			{"famid":"1","display_name":"","name":"3","sex":"F","top_level":"true"}
		];

		$( "#pedigrees" ).append( $( "<div id='pedigree_history'></div>" ) );
		$( "#pedigrees" ).append( $( "<div id='pedigree'></div>" ) );

		var opts = {
				'targetDiv': 'pedigree',
				'btn_target': 'pedigree_history',
				//'nodeclick': pedigree_form.nodeclick,
				'width': ($(window).width() > 450 ? 900 : $(window).width()- 30),
				'height': 600,
				'symbol_size': 30,
				'edit': true,
				'zoomIn': .8,
				'zoomOut': 3.,
				'font_size': '0.75em',
				'edit': true,
				'diseases': $.extend(true, [], DEFAULT_DISEASES),
				'DEBUG': (pedigree_util.urlParam('debug') === null ? false : true)};
				
		var local_dataset = pedcache.current(opts);
		if (local_dataset !== undefined && local_dataset !== null) {
			opts.dataset = local_dataset;
		} else {
			opts.dataset = dataset;
		}
		opts= ptree.build(opts);

		//<!-- edit disease configuration -->
		$('#fh_edit_settings').on( "click", function() {
			$('#fh_settings').dialog({
			    autoOpen: false,
			    title: "Disease Configuration",
			    buttons: [
			        {
			        	text: "RESET",
			          	click: function() {
			          		$("#reset_dialog").dialog({
			          	        modal: true,
			          	        buttons: {
			          	          Yes: function() {
							      	newdataset = ptree.copy_dataset(pedcache.current(opts));
							        opts.dataset = newdataset;
							        opts.diseases = $.extend(true, [], DEFAULT_DISEASES);
							        ptree.rebuild(opts);
							        update_diseases();
							        localStorage.setItem('diseases', JSON.stringify(opts.diseases));
							        $(this).dialog("close");
			          	          },
			          	          No: function() {
			          	          	$(this).dialog("close");
			          	          }
			          	        }
			          	      });
				        }
				    },
			        {
			          text: "OK",
			          click: function() {
			            $( this ).dialog( "close" );
			            newdataset = ptree.copy_dataset(pedcache.current(opts));
			            opts.dataset = newdataset;
			            ptree.rebuild(opts);
			          }
			        }
			      ],
			    width: ($(window).width() > 400 ? 450 : $(window).width()- 30)
			});
			var html_dis =
				'<br><div class="row">'+
					'<div class="col-md-4 text-right">'+
				  		'<label for="dis_name">Add Disease:</label>' +
					'</div>' +
					'<div class="col-md-6">'+
			  			'<input type="text" class="form-control" id="dis_name">' +
					'</div>' +
					'<div class="col-md-2">'+
						'<label class="btn btn-default btn-file">' +
							'<input id="add_disease" type="button" style="display: none;"/><i class="fa fa-plus" aria-hidden="true"></i>' +
						'</label>' +
					'</div>' +
				'</div><br><div id="disease_table"></div>';
				
			function validTextColour(stringToTest) {
			    //Alter the following conditions according to your need.
			    if (stringToTest === "") { return false; }
			    if (stringToTest === "inherit") { return false; }
			    if (stringToTest === "transparent") { return false; }
			    
			    var image = document.createElement("img");
			    image.style.color = "rgb(0, 0, 0)";
			    image.style.color = stringToTest;
			    if (image.style.color !== "rgb(0, 0, 0)") { return true; }
			    image.style.color = "rgb(255, 255, 255)";
			    image.style.color = stringToTest;
			    var isValid = image.style.color !== "rgb(255, 255, 255)";
			    image.remove();
			    return isValid;
			}

			function update_diseases() {
				var tab = "<table class='table table-condensed table-striped table-bordered'>" +
							"<thead><tr><th>Disease</th><th>Colour</th><th></th></tr></thead>";
				$.each(opts.diseases, function(k, v) {
					var disease_colour = '&thinsp;<span style="padding-left:5px;background:'+opts.diseases[k].colour+'"></span>';
					tab += "<tr>" +
								"<td style='text-align:right'>"+capitaliseFirstLetter(v.type.replace(/_/g , " "))+
									disease_colour+"&nbsp;</td>" +
								"<td>" +
							      "<input type='text' class='form-control' id='disease_colour-"+v.type+"' value='" + opts.diseases[k].colour + "'>" +
								"</td>" +
								"<td>" +
									"<label class='btn btn-default btn-sm'>" +
										"<input id='delete_disease-"+v.type+"' type='button' style='display: none;'/>" +
											"<i class='fa fa-times' aria-hidden='true' style='color:#8B0000'></i>" +
									"</label>" +
								"</td>" +
							"</tr>";
				});
				tab += "</table>";
				$('#disease_table').html(tab);

				$("input[id^='delete_disease-']").on( "click", function() {
					var this_disease = $(this).attr('id').replace('delete_disease-', '');
					var new_diseases = $.extend(true, [], opts.diseases);
					new_diseases = new_diseases.filter(function(el) {
					    return el.type !== this_disease;
					});
					opts.diseases = new_diseases;
					localStorage.setItem('diseases', JSON.stringify(opts.diseases));
					update_diseases();
				});

				$('input[id^="disease_colour-"]').on('keypress mouseleave', function(e) {
	                var code = (e.keyCode ? e.keyCode : e.which);
	                if (code == 13 || code == 0) {
	                	var this_disease = $(this).attr('id').replace('disease_colour-', '');
						var this_colour = $(this).val();
						// test if valid colour string or hex
						if(!validTextColour(this_colour) && !/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(this_colour)){
							console.error('Invalid colour!', this_colour);
							return;
						}
						var new_diseases = $.extend(true, [], opts.diseases);
						$.each(new_diseases, function(index, value) {
	 						if(value.type == this_disease) {
	 							value.colour = this_colour;
	 						}
						});
						opts.diseases = new_diseases;
						localStorage.setItem('diseases', JSON.stringify(opts.diseases));
						update_diseases();
	                }
	            });
			}

			$('#fh_settings').html(html_dis);
			update_diseases();
			$('#fh_settings').dialog('open');
			
			$('#add_disease').on( "click", function() {
				if($('#dis_name').val() == "")
					return;
				var new_diseases = $.extend(true, [], opts.diseases);
				new_diseases.push({'type': $('#dis_name').val().replace(/\s/g , "_"), 'colour': 'red'});
				opts.diseases = new_diseases;
				localStorage.setItem('diseases', JSON.stringify(opts.diseases));
				update_diseases();
			});
		});

		// Update dataset from handsontable
		function loadFromHot() {
			let myDeepClone = JSON.stringify(hot.getSourceData()) //save hot
			
			var obj = FormatToPedigreeJS(hot.getSourceData());
			opts.dataset = obj

			$('<div id="msgDialog">Resetting the pedigree may result in loss of some data.</div>').dialog({
					title: 'Confirm Reset',
					resizable: false,
					height: "auto",
					width: 400,
					modal: true,
					buttons: {
						Continue: function() {
					    	ptree.rebuild(opts)
					    	$(this).dialog( "close" );
						},
						Cancel: function() {
							$(this).dialog( "close" );
							return;
					    }
					}
				});
			
			hot.loadData(JSON.parse(myDeepClone)) //reload hot. Otherwise hot is cleared. Bug ?
		}

		$('#loadFromHot').click(function() {
			loadFromHot();
		});
		
	});
	</script>

	<!-- load handsontable module --> 
	<script src="https://cdn.jsdelivr.net/npm/handsontable@7.4.2/dist/handsontable.full.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/handsontable@7.4.2/dist/handsontable.full.min.css" rel="stylesheet" media="screen">

</head>

<body>	
	<div style="text-align:center">
		<h3>GeneTree</h3>
		
		<!--  buttons edit familly-->
		<div id="dropdownFam" class="dropdown" style="display:inline;">
			<button id="editFamily" data-toggle="dropdown" class="dropbtn" aria-haspopup="true" aria-expanded="false">Add new familly&nbsp;<span class="caret"></span></button>
			<div class="dropdown-menu" role="menu" aria-labelledby="editFamily" style="padding:10px;min-width:320px" onclick="event.stopPropagation()">
				<li>
					<div class="alert alert-info" style="padding:5px;margin-bottom:5px"><strong>Initial family structure:</strong>
						<form>
							<div id="famStructure" class="row" >
								<div class="col-md-4">
									<label class="radio-inline" data-toggle="popover">
										<input type="radio" name="default_fam" value="nuclear" checked="">Nuclear
									</label>
								</div>
								<div class="col-md-4" style="padding:0 5px;">
									<label class="radio-inline" data-toggle="popover">
										<input type="radio" name="default_fam" value="extended1">1<sup>st</sup> degree
									</label>
								</div>
								<div class="col-md-4" style="padding:0 5px;">
									<label class="radio-inline" data-toggle="popover">
										<input type="radio" name="default_fam" value="extended2">2<sup>nd</sup> degree
									</label>
								</div>
							</div>
							<div class="row">
								<div class="col-md-8 text-right">
									<button id="submitDefautFam" class="intext-btn">Build</button>
								</div>
							</div>
						</form>

						<script>
							var buttonSubmit = document.getElementById('submitDefautFam');
							var form = document.querySelector("form") //

							buttonSubmit.addEventListener('click', function() {
								var data = new FormData(form);
								var output = "";
								for (const entry of data) {
									output = entry[1];
								};
								if (output == "nuclear") {
									hot.loadData(JSON.parse(myDataSafe));
									hot.loadData(JSON.parse(myDataSafe));
								} else if (output == "extended1") {
									hot.loadData(JSON.parse(myDataExtended1Safe));
									hot.loadData(JSON.parse(myDataExtended1Safe));
								} else if (output == "extended2") {
									hot.loadData(JSON.parse(myDataExtended2Safe));
									hot.loadData(JSON.parse(myDataExtended2Safe));
								}
								event.preventDefault();
								document.getElementById('dropdownFam').classList.remove('open')
						  	});
						</script>
					</div>
				</li>
				<li>
					<div class="alert alert-info" style="padding:5px;margin-bottom:5px">
						<strong>Number of:</strong>
						<div class="builder">

							<div class="row">
								<div class="col-md-8 text-right"><label>brothers</label></div>
								<div class="col-md-4"><input type="number" id="brother" min="0" max="20"></div>
							</div>

							<div class="row">
								<div class="col-md-8 text-right"><label>sisters</label></div>
								<div class="col-md-4"><input type="number" id="sister" min="0" max="20"></div>
							</div>

							<div class="row">
								<div class="col-md-8 text-right"><label>sons</label></div>
								<div class="col-md-4"><input type="number" id="son" min="0" max="20"></div>
							</div>

							<div class="row">
								<div class="col-md-8 text-right"><label>daughters</label></div>
								<div class="col-md-4"><input type="number" id="daughter" min="0" max="20"></div>
							</div>

							<!-- submit button -->
							<div class="row">
								<div class="col-md-8 text-right">
									<button id="submitCustomFam" class="intext-btn">Build</button>
								</div>
							</div>
						</div>
						<script>
							var buttonSubmit = document.getElementById('submitCustomFam');
							var brotherInput = document.querySelector('#brother')
							var sisterInput = document.querySelector('#sister')
							var sonInput = document.querySelector('#son')
							var daughterInput = document.querySelector('#daughter')

							buttonSubmit.addEventListener('click', function() {
								//reset pedigree
								hot.loadData(JSON.parse(myDataSafe));
								//select index
								hot.selectCell(0, 1);

								if( brotherInput.value > 0){
									for (let step = 0; step < brotherInput.value; step++) {
										createBrother()
									}
								}
								if( sisterInput.value > 0){
									for (let step = 0; step < sisterInput.value; step++) {
										createSister()
									}
								}
								if( sonInput.value > 0){
									for (let step = 0; step < sisterInput.value; step++) {
										createChild('M')
									}
								}
								if( daughterInput.value > 0){
									for (let step = 0; step < sisterInput.value; step++) {
										createChild('F')
									}
								}
								//event.preventDefault();
								document.getElementById('dropdownFam').classList.remove('open')
						  	});
						</script>
					</div>
				</li>
			</div>
		</div>

		<!-- create buttons -->
		<button id="reset" class="intext-btn">Reset</button>
		<script> var buttonParents = document.getElementById('reset');
			Handsontable.dom.addEvent(buttonParents, 'click', function() {
				hot.loadData(JSON.parse(myDataSafe))
			});
		</script>

		&nbsp &nbsp &nbsp

		<button id="add-parents" class="intext-btn">Add parents</button>
		<script> var buttonParents = document.getElementById('add-parents');
			Handsontable.dom.addEvent(buttonParents, 'click', function() {
				createParents();
			});
		</script>

		<button id="add-brother" class="intext-btn">Add brother</button>
		<script> var buttonParents = document.getElementById('add-brother');
			Handsontable.dom.addEvent(buttonParents, 'click', function() {
				createBrother();
			});
		</script>

		<button id="add-sister" class="intext-btn">Add sister</button>
		<script> var buttonParents = document.getElementById('add-sister');
			Handsontable.dom.addEvent(buttonParents, 'click', function() {
				createSister();
			});
		</script>

		<button id="add-son" class="intext-btn">Add son</button>
		<script> var buttonSon = document.getElementById('add-son');
			Handsontable.dom.addEvent(buttonSon, 'click', function() {
				createChild("M");
			});
		</script>

		<button id="add-daughter" class="intext-btn">Add daughter</button>
		<script> var buttonDaughter = document.getElementById('add-daughter');
			Handsontable.dom.addEvent(buttonDaughter, 'click', function() {
				createChild("F");
			});
		</script>

		<div></div>
		</br>

		<!-- create handsontable table -->
		<div id="example" style="display:inline-block;"></div>
		</br>
		<script>
			//Defaut datasets
			var myData = [
				{"FamID": "1","Name": "","IndivID": "1","FathID": "2","MothID": "3","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":"","proband": true},
				{"FamID": "1","Name": "","IndivID": "2","FathID": "0","MothID": "0","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "3","FathID": "0","MothID": "0","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""}
			]
			var myDataSafe = JSON.stringify(myData) //save 
			
			var myDataExtended1 = [
				{"FamID": "1","Name": "","IndivID": "1","FathID": "2","MothID": "3","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":"","proband": true},
				{"FamID": "1","Name": "","IndivID": "2","FathID": "4","MothID": "5","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "3","FathID": "6","MothID": "7","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "4","FathID": "0","MothID": "0","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "5","FathID": "0","MothID": "0","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "6","FathID": "0","MothID": "0","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "7","FathID": "0","MothID": "0","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""}
			]
			var myDataExtended1Safe = JSON.stringify(myDataExtended1) //save

			var myDataExtended2 = [
				{"FamID": "1","Name": "","IndivID": "1","FathID": "2","MothID": "3","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":"","proband": true},
				{"FamID": "1","Name": "","IndivID": "2","FathID": "4","MothID": "5","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "3","FathID": "6","MothID": "7","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "4","FathID": "8","MothID": "9","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "5","FathID": "10","MothID": "11","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "6","FathID": "12","MothID": "13","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "7","FathID": "14","MothID": "15","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "8","FathID": "0","MothID": "0","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "9","FathID": "0","MothID": "0","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "10","FathID": "0","MothID": "0","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "11","FathID": "0","MothID": "0","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "12","FathID": "0","MothID": "0","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "13","FathID": "0","MothID": "0","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "14","FathID": "0","MothID": "0","Sex": "M","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""},
				{"FamID": "1","Name": "","IndivID": "15","FathID": "0","MothID": "0","Sex": "F","Affected":"1","Deceased":"0","Age":"","Yob":"","Disease1":"","Age1":"","Disease2":"","Age2":"","Disease3":"","Age3":""}
			]
			var myDataExtended2Safe = JSON.stringify(myDataExtended2) //save

		//define diseases
		var diseasesDefaut = ['breast_cancer', 'breast_cancer2','ovarian_cancer','pancreatic_cancer','prostate_cancer']
		var diseases = diseasesDefaut

		// define column to display
		var cols = [{
			data: 'FamID'
			}, {
			data: 'Name'
			}, {
			data: 'IndivID'
			}, {
			data: 'FathID'
			}, {
			data: 'MothID'
			}, {
			data: 'Sex'//,
			//type: 'dropdown',
      		//source: ['M','F','NA',' ']
			}, {
			data: 'Affected',
			type: 'checkbox',
			checkedTemplate: '2',
			uncheckedTemplate: '1'
			}, {
			data: 'Deceased',
			type: 'checkbox',
			checkedTemplate: '1',
			uncheckedTemplate: '0'
			}, {
			data: 'Age',
			type: 'numeric'
			}, {
			data: 'Yob',
			type: 'numeric'
			}, {
			data: 'Disease1',
			type: 'dropdown',
      		source: diseases
			}, {
			data: 'Age1',
			type: 'numeric'
			}, {
			data: 'Disease2',
			type: 'dropdown',
      		source: diseases
			}, {
			data: 'Age2',
			type: 'numeric'
			}, {
			data: 'Disease3',
			type: 'dropdown',
      		source: diseases
			}, {
			data: 'Age3',
			type: 'numeric'
			}];

		// define column header
		var cols_header = []
		cols.forEach(function(element) { cols_header.push(element.data); })
		
		// create handsonetable
		var container = document.getElementById('example');
		var hot = new Handsontable(container, {
			data: myData,
			rowHeaders: false, //true,
			colHeaders: cols_header, 
			columns: cols,
			filters: true,
			dropdownMenu: true,
			className: "htCenter",
			contextMenu: true,
			outsideClickDeselects: false,
			hiddenColumns: {
				columns: [0],
				indicators: false
			},
			licenseKey: 'non-commercial-and-evaluation'
			});

		var setter = false;
		hot.addHook('afterChange', function(changes, source) {
			if(changes != null) {
				col = changes[0][1];
				var deceasedIndex = 7
				row = changes[0][0];
				dead = this.getSourceDataAtCell(row, deceasedIndex)
				if((source == 'edit') && (changes.length == 1) && (col == 'Age' || col == 'Yob') && (dead != 1)) {
					newValue = changes[0][3];
					var today = new Date();
					var y = today.getFullYear();
					if (!setter) {
							setter = true;
						if(col == 'Age'){
							let value = y-newValue
							this.setDataAtRowProp(row, 'Yob', value)

						}else {
							let value = y-newValue
							this.setDataAtRowProp(row, 'Age', value)
						}
					} else {
						setter = false;
					}
				}
			}
		},)

		</script>
		</br>		

		<!-- create export to TSV button -->
		<button id="export-file" class="intext-btn">Download TSV</button>
		<script> var button1 = document.getElementById('export-file');
  		var exportPlugin1 = hot.getPlugin('exportFile');
  
		button1.addEventListener('click', function() {
			exportPlugin1.downloadFile('csv', {
			bom: false,
			columnDelimiter: '\t',
			columnHeaders: cols_header,
			exportHiddenColumns: true,
			exportHiddenRows: true,
			fileExtension: 'tsv',
			filename: 'GeneTree_[YYYY]-[MM]-[DD]',
			mimeType: 'text/csv',
			rowDelimiter: '\r\n',
			rowHeaders: false
			});
		});
		</script>

		<!-- create export to PED button -->		
		<button id="savePed" class="intext-btn">Download as PED</button>
		<script>
		Handsontable.dom.addEvent(savePed, 'click', function() {
			var toKeep = ['FamID','IndivID','FathID','MothID','Sex','Affected']
			JSONToPEDConvertor(hot.getSourceData(), toKeep); 
  		});
		</script>

		<!-- create export to JSON button -->
		<button id="exportJson" class="intext-btn">Download as JSON</button>
		<script>
		Handsontable.dom.addEvent(exportJson, 'click', function() {
			let myDeepClone = JSON.stringify(hot.getSourceData()) //save hot

			ExportJSON(hot.getSourceData())
			hot.loadData(JSON.parse(myDeepClone)) //reload hot. Otherwise hot is cleared. Bug ?
		});
		</script>

	<br>
	<!-- create pedigree buttons -->
	<div class="text-center">
		<h3>Pedigree</h3>
		<label class="btn btn-default btn-file">
			<input id="loadFromHot" type="button" style="display: none;"/>Update from table
		</label>
		<label class="btn btn-default btn-file">
				<input id="load" type="file" style="display: none;"/>Load
		</label>	
		<label class="btn btn-default btn-file">
				<input id="save" type="button" style="display: none;"/>Save
		</label>
		<label class="btn btn-default btn-file">
				<input id="svg_download" type="button" style="display: none;"/>SVG
		</label>
		<label class="btn btn-default btn-file">
				<input id="png_download" type="button" style="display: none;"/>PNG
		</label>
		<label class="btn btn-default btn-file">
			<input id="fh_edit_settings" type="button" style="display: none;"><i class="fa fa-cog" aria-hidden="true"></i>
		</label>

		<!-- create pedigree -->
		<div id="pedigrees"></div>
		<div id="node_properties"></div>

		<!-- create disease settings -->
		<div id="fh_settings"></div>
		<div id="reset_dialog" title="Confirmation Disease Reset"></div>

		<br>
	</div>
	<div class="text-center">
		<h3>Pedigree history</h3>
		<textarea id="story" name="story" rows="5" cols="33"></textarea>
		<script>
			var rawData = {
                "FamID": "1",
                "Name": "",
                "IndivID": "1",
                "FathID": "2",
                "MothID": "3",
                "Sex": "F",
                "Affected":"1",
                "Deceased":"0"
                }

			var result = "in progress" //"il s'agit d'un " + rawData.Sex + "de x ans, né(e) en y."

			document.getElementById('story').value = result

		</script>
		

	</div>
</body>

</html>
